<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cozy Campfire Pomodoro</title>
    <!-- Chart.js for pie chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            min-height: 100vh;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #fff;
            overflow-x: hidden;
            padding: 20px;
            position: relative;
            gap: 20px;
        }

        /* Campfire GIF as full background */
        .campfire-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            overflow: hidden;
        }

        .campfire-background img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            opacity: 0.4;
            transition: opacity 0.5s ease;
        }

        /* Dark overlay for better readability */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, rgba(15, 52, 96, 0.7) 0%, rgba(22, 33, 62, 0.5) 50%, rgba(26, 26, 46, 0.7) 100%);
            z-index: 1;
        }

        /* Pixelated stars background */
        .stars {
            position: fixed;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 2;
        }

        .star {
            position: absolute;
            width: 3px;
            height: 3px;
            background: #fff;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        /* Panel Header with Minimize Button */
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            cursor: pointer;
            flex-wrap: nowrap;  /* Add this */
            min-width: 100%;    /* Add this */
        }

        .panel-header h2 {
            font-size: 1.8em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            color: #ffd700;
        }

        .minimize-btn {
            background: transparent;
            border: none;
            color: #ffd700;
            width: 35px;
            height: 35px;
            cursor: pointer;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .minimize-btn:hover {
            color: #ffaa00;
            transform: scale(1.2);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.6);
        }

        .fullscreen-btn {
            background: transparent;
            border: none;
            color: #ffd700;
            width: 35px;
            height: 35px;
            cursor: pointer;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
            margin-left: 10px;
        }

        .fullscreen-btn:hover {
            color: #ffaa00;
            transform: scale(1.2);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.6);
        }

        .panel-header-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* LEFT SIDE PANEL - Stats and Sessions */
        .left-panel {
            position: relative;
            z-index: 3;
            padding: 30px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 20px;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            max-width: 400px;
            width: 100%;
            max-height: 95vh;
            overflow-y: auto;
            margin-left: 20px;
            transition: all 0.3s ease;
        }

        .left-panel.minimized {
            min-width: 250px;  /* Increase from 200px */
            max-width: 250px;  /* Increase from 200px */
            padding: 20px;
            overflow: visible;  /* Add this */
        }

        .left-panel.minimized .panel-content {
            display: none;
        }

        /* RIGHT SIDE PANEL - Timer and Controls */
        .right-panel {
            position: relative;
            z-index: 3;
            text-align: center;
            padding: 40px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 20px;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            max-width: 450px;
            width: 100%;
            max-height: 95vh;
            overflow-y: auto;
            margin-right: 20px;
            transition: all 0.3s ease;
        }

        .right-panel.minimized {
            min-width: 250px;
            max-width: 250px;
            padding: 20px;
        }

        .right-panel.minimized .panel-content {
            display: none;
        }

        /* Floating Timer (visible when minimized) */
        .floating-timer {
            display: none;
            font-size: 2.5em;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.9);
            text-align: center;
            margin: 10px 0;
        }

        .right-panel.minimized .floating-timer {
            display: block;
        }

        .floating-session-type {
            display: none;
            font-size: 1em;
            color: #ffaa00;
            text-align: center;
        }

        .right-panel.minimized .floating-session-type {
            display: block;
        }

        /* Scrollbar styling */
        .left-panel::-webkit-scrollbar,
        .right-panel::-webkit-scrollbar {
            width: 8px;
        }

        .left-panel::-webkit-scrollbar-track,
        .right-panel::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .left-panel::-webkit-scrollbar-thumb,
        .right-panel::-webkit-scrollbar-thumb {
            background: rgba(255, 170, 0, 0.5);
            border-radius: 4px;
        }

        /* Live Users Badge */
        .live-users-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: rgba(0, 255, 136, 0.2);
            border: 2px solid rgba(0, 255, 136, 0.4);
            border-radius: 20px;
            margin-bottom: 20px;
            font-size: 0.95em;
        }

        .live-indicator {
            width: 10px;
            height: 10px;
            background: #00ff88;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }

        /* Statistics Box */
        .stats-box {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .stats-box h3 {
            color: #ffd700;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #ccc;
            font-size: 0.95em;
        }

        .stat-value {
            color: #ffaa00;
            font-weight: bold;
            font-size: 1.1em;
        }

        /* Pie Chart Container */
        .chart-container {
            margin-top: 25px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chart-container h3 {
            color: #ffd700;
            margin-bottom: 15px;
            font-size: 1.2em;
            text-align: center;
        }

        #sessionChart {
            max-height: 300px;
        }

        /* Session History */
        .session-history-compact {
            padding: 20px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-height: 400px;
            overflow-y: auto;
        }

        .session-history-compact h3 {
            margin-bottom: 15px;
            color: #ffd700;
            font-size: 1.2em;
        }

        .session-item {
            padding: 10px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.05);
            border-left: 4px solid #ff6b00;
            border-radius: 5px;
            text-align: left;
            font-size: 0.9em;
        }

        .session-item.break-session {
            border-left-color: #00ff88;
        }

        .session-time {
            font-size: 0.9em;
            color: #ffaa00;
        }

        .session-duration {
            font-size: 0.85em;
            color: #aaa;
            margin-top: 5px;
        }

        .no-sessions {
            color: #888;
            font-style: italic;
            padding: 20px;
            font-size: 0.9em;
        }

        .session-history-compact::-webkit-scrollbar {
            width: 6px;
        }

        .session-history-compact::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .session-history-compact::-webkit-scrollbar-thumb {
            background: rgba(255, 170, 0, 0.5);
            border-radius: 3px;
        }

        /* Right Panel Styling */
        h1 {
            font-size: 2em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            image-rendering: pixelated;
        }

        .timer-display {
            font-size: 5em;
            font-weight: bold;
            margin: 30px 0;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.9);
            font-family: 'Courier New', monospace;
            color: #ffd700;
        }

        .session-type {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .fire-stage-indicator {
            margin-top: 10px;
            font-size: 0.9em;
            color: #ffaa00;
            opacity: 0.9;
        }

        .current-session-info {
            margin-top: 15px;
            font-size: 0.9em;
            color: #88ff88;
        }

        /* Progress bar */
        .progress-container {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin-top: 20px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff6b00, #ffaa00);
            width: 100%;
            transition: width 1s linear;
        }

        /* Controls */
        .controls {
            margin-top: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        button {
            padding: 15px 25px;
            font-size: 1.1em;
            font-family: 'Courier New', monospace;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Settings panel */
        .settings-panel {
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-top: 12px;
        }

        .setting-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .setting-item label {
            font-size: 0.85em;
            color: #ffaa00;
        }

        .setting-item input[type="number"],
        .setting-item input[type="range"],
        .setting-item select {
            padding: 8px;
            font-size: 0.9em;
            font-family: 'Courier New', monospace;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
        }

        .setting-item select {
            cursor: pointer;
        }

        .setting-item select option {
            background: #1a1a2e;
            color: #fff;
        }

        .setting-item input[type="file"] {
            padding: 5px;
            font-size: 0.8em;
            font-family: 'Courier New', monospace;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            cursor: pointer;
        }

        .settings-toggle {
            padding: 10px 20px;
            font-size: 0.95em;
            margin-bottom: 10px;
            width: 100%;
        }

        .settings-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .settings-content.open {
            max-height: 1000px;
            overflow-y: auto;
        }

        .opacity-display {
            font-size: 0.85em;
            color: #aaa;
            margin-top: 5px;
        }

        .background-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .background-section h4 {
            color: #ffd700;
            margin-bottom: 12px;
            font-size: 0.95em;
        }

        .reset-background-btn {
            padding: 8px 16px;
            font-size: 0.85em;
            margin-top: 10px;
            width: 100%;
        }

        /* Audio controls */
        .audio-controls {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="range"] {
            width: 100%;
            cursor: pointer;
        }

        .music-toggle {
            padding: 10px 20px;
            font-size: 0.95em;
        }

        .history-toggle {
            padding: 10px 20px;
            font-size: 0.95em;
            margin-top: 20px;
            width: 100%;
        }

        .session-history-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .session-history-content.open {
            max-height: 500px;
        }

        .clear-history-btn {
            margin-top: 15px;
            padding: 8px 16px;
            font-size: 0.9em;
            width: 100%;
        }

        /* Responsive for smaller screens */
        @media (max-width: 1024px) {
            body {
                flex-direction: column;
                justify-content: center;
            }
            
            .left-panel,
            .right-panel {
                margin: 10px 0;
                max-width: 500px;
            }
            
            .overlay {
                background: rgba(26, 26, 46, 0.8);
            }
        }
    </style>
</head>
<body>
    <!-- Campfire GIF as background -->
    <div class="campfire-background">
        <img id="backgroundGif" src="high_fire.gif" alt="Campfire Background">
    </div>

    <!-- Dark overlay for readability -->
    <div class="overlay"></div>

    <!-- Starry background -->
    <div class="stars" id="stars"></div>

    <!-- LEFT PANEL - Stats and Sessions -->
    <div class="left-panel" id="leftPanel">
        <div class="panel-header" onclick="toggleLeftPanel()">
            <h2>üìä Dashboard</h2>
            <div class="panel-header-controls">
                <div class="fullscreen-btn" onclick="event.stopPropagation(); toggleFullscreen()" title="Fullscreen">‚õ∂</div>
                <div class="minimize-btn" id="leftMinimizeBtn">‚ñº</div>
            </div>
        </div>

        <div class="panel-content">
            <!-- Live Users -->
            <div class="live-users-badge">
                <div class="live-indicator"></div>
                <span id="liveUsers">üî• -- people working now</span>
            </div>
            
            <!-- Today's Statistics -->
            <div class="stats-box">
                <h3>Today's Stats</h3>
                <div class="stat-item">
                    <span class="stat-label">Completed Pomodoros</span>
                    <span class="stat-value" id="completedCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Work Time</span>
                    <span class="stat-value" id="totalWorkTime">0h 0m</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Sessions</span>
                    <span class="stat-value" id="totalSessions">0</span>
                </div>
            </div>

            <!-- Pie Chart -->
            <div class="chart-container">
                <h3>üìà Today's Activity</h3>
                <canvas id="sessionChart"></canvas>
            </div>

            <!-- Recent Sessions -->
            <div class="session-history-compact" style="margin-top: 25px;">
                <h3>Recent Sessions</h3>
                <div id="sessionListCompact"></div>
            </div>

            <!-- Full History Toggle -->
            <button class="history-toggle" onclick="toggleHistory()">üìã View Full History</button>
            <div class="session-history-content" id="historyContent">
                <div class="session-history-compact" style="margin-top: 15px;">
                    <h3>All Sessions</h3>
                    <div id="sessionListFull"></div>
                    <button class="clear-history-btn" onclick="clearHistory()">Clear All History</button>
                </div>
            </div>
        </div>
    </div>

    <!-- RIGHT PANEL - Timer and Controls -->
    <div class="right-panel" id="rightPanel">
        <div class="panel-header" onclick="toggleRightPanel()">
            <h1>üèïÔ∏è Campfire Pomodoro üèïÔ∏è</h1>
            <div class="minimize-btn" id="rightMinimizeBtn">‚ñº</div>
        </div>

        <!-- Floating Timer (visible when minimized) -->
        <div class="floating-timer" id="floatingTimer">25:00</div>
        <div class="floating-session-type" id="floatingSessionType">Work</div>

        <div class="panel-content">
            <div class="session-type" id="sessionType">Work Session</div>
            <div class="timer-display" id="timer">25:00</div>
            
            <div class="current-session-info" id="currentSessionInfo"></div>
            <div class="fire-stage-indicator" id="fireStage">üî• Fire: High</div>

            <!-- Progress bar -->
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <button id="startBtn" onclick="startTimer()">Start</button>
                <button id="pauseBtn" onclick="pauseTimer()" disabled>Pause</button>
                <button id="resetBtn" onclick="resetTimer()">Reset</button>
                <button onclick="skipSession()">Skip</button>
            </div>

            <!-- Audio Controls -->
            <div class="audio-controls">
                <div class="setting-item">
                    <label>üéµ Ambient Sound</label>
                    <select id="musicSelect" onchange="changeMusicType()">
                        <option value="none">None (Silent)</option>
                        <option value="ambient">Ambient Tones</option>
                        <option value="fireplace">Cozy Fireplace</option>
                        <option value="rain">Rain & Thunder</option>
                        <option value="forest">Forest Birds</option>
                        <option value="ocean">Ocean Waves</option>
                        <option value="cafe">Coffee Shop</option>
                    </select>
                </div>
                <button class="music-toggle" id="musicToggle" onclick="toggleMusic()">üéµ Play Sound</button>
                
                <div class="setting-item" style="margin-top: 10px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="tickingSoundCheckbox" onchange="toggleTickingSound()" style="width: 20px; height: 20px; cursor: pointer;">
                        <span>‚è±Ô∏è Enable Ticking Sound</span>
                    </label>
                </div>

                <div class="volume-control">
                    <span>üîä</span>
                    <input type="range" id="volumeSlider" min="0" max="100" value="50" onchange="changeVolume(this.value)">
                </div>
            </div>

            <!-- Settings Panel -->
            <button class="settings-toggle" onclick="toggleSettings()">‚öôÔ∏è Settings</button>
            <div class="settings-panel">
                <div class="settings-content" id="settingsContent">
                    <h4 style="color: #ffd700; margin-bottom: 12px; font-size: 0.95em;">Timer Settings</h4>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label>Work Duration (minutes)</label>
                            <input type="number" id="workDuration" value="25" min="1" max="60">
                        </div>
                        <div class="setting-item">
                            <label>Short Break (minutes)</label>
                            <input type="number" id="shortBreak" value="5" min="1" max="30">
                        </div>
                        <div class="setting-item">
                            <label>Long Break (minutes)</label>
                            <input type="number" id="longBreak" value="15" min="1" max="60">
                        </div>
                    </div>
                    
                    <div class="background-section">
                        <h4>Background Settings</h4>
                        <div class="settings-grid">
                            <div class="setting-item">
                                <label>Background Opacity</label>
                                <input type="range" id="opacitySlider" min="0" max="100" value="40" oninput="changeBackgroundOpacity(this.value)">
                                <div class="opacity-display" id="opacityDisplay">40%</div>
                            </div>
                        </div>
                        
                        <div class="setting-item" style="margin-top: 12px;">
                            <label>Change Background Image</label>
                            <input type="file" id="backgroundUpload" accept="image/*,video/*,.gif" onchange="changeBackgroundImage(this)">
                            <button class="reset-background-btn" onclick="resetToDefaultBackground()">Reset to Campfire</button>
                        </div>
                    </div>
                    
                    <button onclick="applySettings()" style="margin-top: 12px; width: 100%;">Apply Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyBnokDnAfe4FMsmpMwgENOmpzWWNyG3rB8",
            authDomain: "campfire-pomodoro.firebaseapp.com",
            databaseURL: "https://campfire-pomodoro-default-rtdb.firebaseio.com",
            projectId: "campfire-pomodoro",
            storageBucket: "campfire-pomodoro.firebasestorage.app",
            messagingSenderId: "1003491566904",
            appId: "1:1003491566904:web:8f9718793a7ebf7104cdcd",
            measurementId: "G-TRQ2V66N2N"
        };

        // Initialize Firebase
        let database;
        let myConnectionRef;
        let connectedRef;

        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            
            const activeUsersRef = database.ref('activeUsers');
            myConnectionRef = database.ref('activeUsers').push();
            
            connectedRef = database.ref('.info/connected');
            connectedRef.on('value', (snapshot) => {
                if (snapshot.val() === true) {
                    myConnectionRef.set(true);
                    myConnectionRef.onDisconnect().remove();
                }
            });
            
            activeUsersRef.on('value', (snapshot) => {
                const count = snapshot.numChildren();
                document.getElementById('liveUsers').textContent = `üî• ${count} ${count === 1 ? 'person' : 'people'} working now`;
            });
            
            console.log('Firebase connected successfully!');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            document.getElementById('liveUsers').textContent = 'üî• Firebase not configured';
        }

        // ============================================
        // MINIMIZE PANEL FUNCTIONS
        // ============================================
        function toggleLeftPanel() {
            const panel = document.getElementById('leftPanel');
            const btn = document.getElementById('leftMinimizeBtn');
            panel.classList.toggle('minimized');
            btn.textContent = panel.classList.contains('minimized') ? '‚ñ≤' : '‚ñº';
        }

        function toggleRightPanel() {
            const panel = document.getElementById('rightPanel');
            const btn = document.getElementById('rightMinimizeBtn');
            panel.classList.toggle('minimized');
            btn.textContent = panel.classList.contains('minimized') ? '‚ñ≤' : '‚ñº';
            updateFloatingTimer();
        }

        // ============================================
        // FULLSCREEN FUNCTION
        // ============================================
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log('Fullscreen error:', err);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // ============================================
        // TICKING SOUND
        // ============================================
        let tickingEnabled = false;
        let tickingOscillator = null;
        let tickingGain = null;
        let tickingInterval = null;

        function toggleTickingSound() {
            tickingEnabled = document.getElementById('tickingSoundCheckbox').checked;
            
            if (tickingEnabled && isRunning) {
                startTickingSound();
            } else {
                stopTickingSound();
            }
            
            // Save preference
            localStorage.setItem('tickingEnabled', tickingEnabled);
        }

        function startTickingSound() {
            if (!tickingEnabled || !isRunning) return;
            
            stopTickingSound(); // Clean up any existing ticking
            
            // Create ticking sound every second
            tickingInterval = setInterval(() => {
                if (!tickingEnabled || !isRunning) {
                    stopTickingSound();
                    return;
                }
                
                const tickContext = new (window.AudioContext || window.webkitAudioContext)();
                const tickOsc = tickContext.createOscillator();
                const tickGain = tickContext.createGain();
                
                tickOsc.frequency.setValueAtTime(800, tickContext.currentTime);
                tickOsc.type = 'sine';
                
                tickGain.gain.setValueAtTime(0.1, tickContext.currentTime);
                tickGain.gain.exponentialRampToValueAtTime(0.01, tickContext.currentTime + 0.05);
                
                tickOsc.connect(tickGain);
                tickGain.connect(tickContext.destination);
                
                tickOsc.start(tickContext.currentTime);
                tickOsc.stop(tickContext.currentTime + 0.05);
            }, 1000);
        }

        function stopTickingSound() {
            if (tickingInterval) {
                clearInterval(tickingInterval);
                tickingInterval = null;
            }
        }

        function updateFloatingTimer() {
            document.getElementById('floatingTimer').textContent = formatTime(timeLeft);
            const sessionTypeText = document.getElementById('sessionType').textContent;
            const shortType = sessionTypeText.includes('Work') ? 'Work' : 
                             sessionTypeText.includes('Long') ? 'Long Break' : 'Break';
            document.getElementById('floatingSessionType').textContent = shortType;
        }

        // ============================================
        // TIMER & SESSION VARIABLES
        // ============================================
        let workDuration = 25;
        let shortBreakDuration = 5;
        let longBreakDuration = 15;
        
        let timeLeft = workDuration * 60;
        let totalTime = workDuration * 60;
        let timerInterval = null;
        let isRunning = false;
        let isWorkSession = true;
        let completedPomodoros = 0;
        let currentSessionStartTime = null;

        let sessions = [];

        let isUsingCustomBackground = false;
        let customBackgroundURL = null;

        const fireStages = {
            high: 'high_fire.gif',
            mid: 'mid_fire.gif',
            low: 'low_fire.gif',
            none: 'no_fire.gif'
        };

        // ============================================
        // PIE CHART
        // ============================================
        let sessionChart = null;

        function createPieChart() {
            const ctx = document.getElementById('sessionChart').getContext('2d');
            
            if (sessionChart) {
                sessionChart.destroy();
            }

            const hourlyData = calculateHourlyActivity();
            
            sessionChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: hourlyData.labels,
                    datasets: [{
                        data: hourlyData.data,
                        backgroundColor: hourlyData.colors,
                        borderColor: 'rgba(255, 255, 255, 0.3)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#fff',
                                font: {
                                    family: 'Courier New',
                                    size: 11
                                },
                                padding: 10,
                                boxWidth: 12
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + ' min';
                                }
                            }
                        }
                    }
                }
            });
        }

        function calculateHourlyActivity() {
            const today = new Date().toDateString();
            const todaySessions = sessions.filter(s => 
                new Date(s.startTime).toDateString() === today
            );

            // Create 24-hour activity map
            const hourlyActivity = new Array(24).fill(0);
            
            todaySessions.forEach(session => {
                const startHour = new Date(session.startTime).getHours();
                const endHour = new Date(session.endTime).getHours();
                const duration = session.duration;
                
                if (startHour === endHour) {
                    hourlyActivity[startHour] += duration;
                } else {
                    // Split duration across hours
                    const startMinute = new Date(session.startTime).getMinutes();
                    const endMinute = new Date(session.endTime).getMinutes();
                    
                    hourlyActivity[startHour] += 60 - startMinute;
                    hourlyActivity[endHour] += endMinute;
                    
                    for (let h = startHour + 1; h < endHour; h++) {
                        hourlyActivity[h] += 60;
                    }
                }
            });

            // Group into time blocks for better visualization
            const labels = [];
            const data = [];
            const colors = [];

            // Define time blocks (morning, afternoon, evening, night)
            const blocks = [
                { name: 'üåÖ Morning (6-12)', start: 6, end: 12, color: 'rgba(255, 193, 7, 0.7)' },
                { name: '‚òÄÔ∏è Afternoon (12-18)', start: 12, end: 18, color: 'rgba(255, 152, 0, 0.7)' },
                { name: 'üåÜ Evening (18-22)', start: 18, end: 22, color: 'rgba(233, 30, 99, 0.7)' },
                { name: 'üåô Night (22-6)', start: 22, end: 24, color: 'rgba(103, 58, 183, 0.7)' }
            ];

            blocks.forEach(block => {
                let totalMinutes = 0;
                for (let h = block.start; h < block.end; h++) {
                    totalMinutes += hourlyActivity[h];
                }
                if (block.name.includes('Night')) {
                    for (let h = 0; h < 6; h++) {
                        totalMinutes += hourlyActivity[h];
                    }
                }
                
                if (totalMinutes > 0) {
                    labels.push(block.name);
                    data.push(totalMinutes);
                    colors.push(block.color);
                }
            });

            // Calculate idle time
            const totalActiveMinutes = data.reduce((a, b) => a + b, 0);
            const totalMinutesInDay = 24 * 60;
            const idleMinutes = totalMinutesInDay - totalActiveMinutes;

            if (idleMinutes > 0) {
                labels.push('üí§ Idle Time');
                data.push(idleMinutes);
                colors.push('rgba(100, 100, 100, 0.5)');
            }

            // If no activity, show empty state
            if (labels.length === 0) {
                labels.push('No Activity Today');
                data.push(1);
                colors.push('rgba(100, 100, 100, 0.3)');
            }

            return { labels, data, colors };
        }

        // ============================================
        // AUDIO SETUP - MULTIPLE MUSIC OPTIONS
        // ============================================
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let currentMusicType = 'none';
        let isMusicPlaying = false;
        let audioNodes = [];

        function createAmbientSound() {
            stopAllAudio();
            const frequencies = [220, 275, 330, 440];
            
            frequencies.forEach((freq, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.start();
                
                audioNodes.push({ oscillator, gainNode, type: 'ambient' });
            });
        }

        function createFireplaceSound() {
            stopAllAudio();
            
            const rumbleOsc = audioContext.createOscillator();
            const rumbleGain = audioContext.createGain();
            rumbleOsc.type = 'sawtooth';
            rumbleOsc.frequency.setValueAtTime(60, audioContext.currentTime);
            rumbleGain.gain.setValueAtTime(0, audioContext.currentTime);
            rumbleOsc.connect(rumbleGain);
            rumbleGain.connect(audioContext.destination);
            rumbleOsc.start();
            
            const bufferSize = audioContext.sampleRate * 2;
            const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                output[i] = Math.random() * 2 - 1;
            }
            
            const whiteNoise = audioContext.createBufferSource();
            whiteNoise.buffer = noiseBuffer;
            whiteNoise.loop = true;
            
            const noiseFilter = audioContext.createBiquadFilter();
            noiseFilter.type = 'bandpass';
            noiseFilter.frequency.setValueAtTime(1000, audioContext.currentTime);
            
            const noiseGain = audioContext.createGain();
            noiseGain.gain.setValueAtTime(0, audioContext.currentTime);
            
            whiteNoise.connect(noiseFilter);
            noiseFilter.connect(noiseGain);
            noiseGain.connect(audioContext.destination);
            whiteNoise.start();
            
            audioNodes.push(
                { oscillator: rumbleOsc, gainNode: rumbleGain, type: 'fireplace' },
                { oscillator: whiteNoise, gainNode: noiseGain, type: 'fireplace' }
            );
        }

        function createRainSound() {
            stopAllAudio();
            
            const bufferSize = audioContext.sampleRate * 2;
            const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                output[i] = Math.random() * 2 - 1;
            }
            
            const whiteNoise = audioContext.createBufferSource();
            whiteNoise.buffer = noiseBuffer;
            whiteNoise.loop = true;
            
            const filter = audioContext.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(1000, audioContext.currentTime);
            
            const gainNode = audioContext.createGain();
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            
            whiteNoise.connect(filter);
            filter.connect(gainNode);
            gainNode.connect(audioContext.destination);
            whiteNoise.start();
            
            audioNodes.push({ oscillator: whiteNoise, gainNode: gainNode, type: 'rain' });
        }

        function createForestSound() {
            stopAllAudio();
            
            const baseFreqs = [300, 450, 600];
            baseFreqs.forEach(freq => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(freq, audioContext.currentTime);
                gain.gain.setValueAtTime(0, audioContext.currentTime);
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.start();
                audioNodes.push({ oscillator: osc, gainNode: gain, type: 'forest' });
            });
        }

        function createOceanSound() {
            stopAllAudio();
            
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            const lfo = audioContext.createOscillator();
            const lfoGain = audioContext.createGain();
            
            osc.type = 'sine';
            osc.frequency.setValueAtTime(100, audioContext.currentTime);
            
            lfo.frequency.setValueAtTime(0.2, audioContext.currentTime);
            lfoGain.gain.setValueAtTime(30, audioContext.currentTime);
            
            lfo.connect(lfoGain);
            lfoGain.connect(osc.frequency);
            
            gain.gain.setValueAtTime(0, audioContext.currentTime);
            
            osc.connect(gain);
            gain.connect(audioContext.destination);
            
            osc.start();
            lfo.start();
            
            audioNodes.push({ oscillator: osc, gainNode: gain, type: 'ocean' });
        }

        function createCafeSound() {
            stopAllAudio();
            
            const bufferSize = audioContext.sampleRate * 2;
            const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            let lastOut = 0;
            for (let i = 0; i < bufferSize; i++) {
                const white = Math.random() * 2 - 1;
                output[i] = (lastOut + (0.02 * white)) / 1.02;
                lastOut = output[i];
                output[i] *= 3.5;
            }
            
            const noise = audioContext.createBufferSource();
            noise.buffer = noiseBuffer;
            noise.loop = true;
            
            const filter = audioContext.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(800, audioContext.currentTime);
            
            const gainNode = audioContext.createGain();
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            
            noise.connect(filter);
            filter.connect(gainNode);
            gainNode.connect(audioContext.destination);
            noise.start();
            
            audioNodes.push({ oscillator: noise, gainNode: gainNode, type: 'cafe' });
        }

        function stopAllAudio() {
            audioNodes.forEach(node => {
                try {
                    node.gainNode.gain.setTargetAtTime(0, audioContext.currentTime, 0.1);
                    setTimeout(() => {
                        if (node.oscillator.stop) {
                            node.oscillator.stop();
                        }
                    }, 200);
                } catch(e) {}
            });
            audioNodes = [];
        }

        function changeMusicType() {
            const wasPlaying = isMusicPlaying;
            if (wasPlaying) {
                stopMusic();
            }
            currentMusicType = document.getElementById('musicSelect').value;
            if (wasPlaying && currentMusicType !== 'none') {
                playMusic();
            }
        }

        function toggleMusic() {
            if (isMusicPlaying) {
                stopMusic();
            } else {
                playMusic();
            }
        }

        function playMusic() {
            currentMusicType = document.getElementById('musicSelect').value;
            
            if (currentMusicType === 'none') {
                alert('Please select an ambient sound first!');
                return;
            }
            
            switch(currentMusicType) {
                case 'ambient': createAmbientSound(); break;
                case 'fireplace': createFireplaceSound(); break;
                case 'rain': createRainSound(); break;
                case 'forest': createForestSound(); break;
                case 'ocean': createOceanSound(); break;
                case 'cafe': createCafeSound(); break;
            }
            
            const volume = document.getElementById('volumeSlider').value / 100;
            audioNodes.forEach((node, index) => {
                const targetVolume = currentMusicType === 'ambient' 
                    ? volume * 0.05 * (1 - index * 0.15)
                    : volume * 0.15;
                node.gainNode.gain.setTargetAtTime(targetVolume, audioContext.currentTime, 0.5);
            });
            
            isMusicPlaying = true;
            document.getElementById('musicToggle').textContent = 'üîá Stop Sound';
        }

        function stopMusic() {
            audioNodes.forEach(node => {
                node.gainNode.gain.setTargetAtTime(0, audioContext.currentTime, 0.5);
            });
            
            setTimeout(() => stopAllAudio(), 600);
            
            isMusicPlaying = false;
            document.getElementById('musicToggle').textContent = 'üéµ Play Sound';
        }

        function changeVolume(value) {
            if (isMusicPlaying) {
                audioNodes.forEach((node, index) => {
                    const targetVolume = currentMusicType === 'ambient'
                        ? value / 100 * 0.05 * (1 - index * 0.15)
                        : value / 100 * 0.15;
                    node.gainNode.gain.setTargetAtTime(targetVolume, audioContext.currentTime, 0.1);
                });
            }
        }

        function createNotificationSound() {
            const notificationAudioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            const times = [0, 0.15, 0.3];
            const frequencies = [523.25, 659.25, 783.99];
            
            times.forEach((time, index) => {
                const oscillator = notificationAudioContext.createOscillator();
                const gainNode = notificationAudioContext.createGain();
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(frequencies[index], notificationAudioContext.currentTime);
                
                gainNode.gain.setValueAtTime(0, notificationAudioContext.currentTime + time);
                gainNode.gain.linearRampToValueAtTime(0.3, notificationAudioContext.currentTime + time + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, notificationAudioContext.currentTime + time + 0.4);
                
                oscillator.connect(gainNode);
                gainNode.connect(notificationAudioContext.destination);
                
                oscillator.start(notificationAudioContext.currentTime + time);
                oscillator.stop(notificationAudioContext.currentTime + time + 0.4);
            });
        }

        // ============================================
        // BACKGROUND FUNCTIONS
        // ============================================
        function changeBackgroundOpacity(value) {
            const backgroundImg = document.getElementById('backgroundGif');
            backgroundImg.style.opacity = value / 100;
            document.getElementById('opacityDisplay').textContent = value + '%';
            localStorage.setItem('backgroundOpacity', value);
        }

        function changeBackgroundImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const backgroundImg = document.getElementById('backgroundGif');
                    backgroundImg.src = e.target.result;
                    isUsingCustomBackground = true;
                    customBackgroundURL = e.target.result;
                    localStorage.setItem('customBackground', e.target.result);
                    alert('Custom background applied!');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function resetToDefaultBackground() {
            isUsingCustomBackground = false;
            customBackgroundURL = null;
            localStorage.removeItem('customBackground');
            updateCampfireGif();
            document.getElementById('backgroundUpload').value = '';
            alert('Background reset to campfire GIFs!');
        }

        // ============================================
        // SETTINGS FUNCTIONS
        // ============================================
        function toggleSettings() {
            const content = document.getElementById('settingsContent');
            content.classList.toggle('open');
        }

        function applySettings() {
            workDuration = parseInt(document.getElementById('workDuration').value);
            shortBreakDuration = parseInt(document.getElementById('shortBreak').value);
            longBreakDuration = parseInt(document.getElementById('longBreak').value);
            
            if (!isRunning) {
                if (isWorkSession) {
                    timeLeft = workDuration * 60;
                    totalTime = workDuration * 60;
                } else {
                    const isLongBreak = completedPomodoros % 4 === 0;
                    timeLeft = isLongBreak ? longBreakDuration * 60 : shortBreakDuration * 60;
                    totalTime = timeLeft;
                }
                updateDisplay();
            }
            
            alert('Settings applied!');
        }

        // ============================================
        // HISTORY FUNCTIONS
        // ============================================
        function toggleHistory() {
            const content = document.getElementById('historyContent');
            content.classList.toggle('open');
            if (content.classList.contains('open')) {
                displayFullHistory();
            }
        }

        function saveSession(type, startTime, endTime, completed) {
            const session = {
                type: type,
                startTime: startTime,
                endTime: endTime,
                duration: Math.floor((endTime - startTime) / 1000 / 60),
                completed: completed
            };
            
            sessions.push(session);
            localStorage.setItem('pomodoroSessions', JSON.stringify(sessions));
            updateStats();
            displayRecentSessions();
            createPieChart();
        }

        function displayRecentSessions() {
            const sessionList = document.getElementById('sessionListCompact');
            
            if (sessions.length === 0) {
                sessionList.innerHTML = '<div class="no-sessions">No sessions yet</div>';
                return;
            }
            
            const recentSessions = sessions.slice(-5).reverse();
            
            let html = '';
            recentSessions.forEach(session => {
                const startTime = new Date(session.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const endTime = new Date(session.endTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const statusEmoji = session.completed ? '‚úÖ' : '‚è∏Ô∏è';
                const typeClass = session.type.includes('Break') ? 'break-session' : '';
                
                html += `
                    <div class="session-item ${typeClass}">
                        <div>${statusEmoji} ${session.type}</div>
                        <div class="session-time">${startTime} - ${endTime}</div>
                        <div class="session-duration">${session.duration} min</div>
                    </div>
                `;
            });
            
            sessionList.innerHTML = html;
        }

        function displayFullHistory() {
            const sessionList = document.getElementById('sessionListFull');
            
            if (sessions.length === 0) {
                sessionList.innerHTML = '<div class="no-sessions">No sessions recorded yet</div>';
                return;
            }
            
            const groupedSessions = {};
            sessions.forEach(session => {
                const date = new Date(session.startTime).toLocaleDateString();
                if (!groupedSessions[date]) {
                    groupedSessions[date] = [];
                }
                groupedSessions[date].push(session);
            });
            
            let html = '';
            Object.keys(groupedSessions).reverse().forEach(date => {
                html += `<div style="margin-top: 15px; font-weight: bold;">${date}</div>`;
                groupedSessions[date].reverse().forEach(session => {
                    const startTime = new Date(session.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    const endTime = new Date(session.endTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    const statusEmoji = session.completed ? '‚úÖ' : '‚è∏Ô∏è';
                    const typeClass = session.type.includes('Break') ? 'break-session' : '';
                    
                    html += `
                        <div class="session-item ${typeClass}">
                            <div>${statusEmoji} ${session.type}</div>
                            <div class="session-time">${startTime} - ${endTime}</div>
                            <div class="session-duration">${session.duration} min</div>
                        </div>
                    `;
                });
            });
            
            sessionList.innerHTML = html;
        }

        function clearHistory() {
            if (confirm('Clear all session history?')) {
                sessions = [];
                localStorage.removeItem('pomodoroSessions');
                updateStats();
                displayRecentSessions();
                displayFullHistory();
                createPieChart();
            }
        }

        // ============================================
        // STATS UPDATE
        // ============================================
        function updateStats() {
            const today = new Date().toDateString();
            
            const todayCompletedPomodoros = sessions.filter(s => {
                return s.type === 'Work Session' && 
                       s.completed && 
                       new Date(s.startTime).toDateString() === today;
            }).length;
            
            const todayWorkMinutes = sessions.filter(s => {
                return s.type === 'Work Session' && 
                       new Date(s.startTime).toDateString() === today;
            }).reduce((total, session) => total + session.duration, 0);
            
            const hours = Math.floor(todayWorkMinutes / 60);
            const minutes = todayWorkMinutes % 60;
            
            const todayTotalSessions = sessions.filter(s => {
                return new Date(s.startTime).toDateString() === today;
            }).length;
            
            document.getElementById('completedCount').textContent = todayCompletedPomodoros;
            document.getElementById('totalWorkTime').textContent = `${hours}h ${minutes}m`;
            document.getElementById('totalSessions').textContent = todayTotalSessions;
        }

        // ============================================
        // VISUAL FUNCTIONS
        // ============================================
        function generateStars() {
            const starsContainer = document.getElementById('stars');
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                starsContainer.appendChild(star);
            }
        }

        function updateCampfireGif() {
            if (isUsingCustomBackground) {
                return;
            }

            const percentage = (timeLeft / totalTime) * 100;
            const backgroundImg = document.getElementById('backgroundGif');
            const fireStageText = document.getElementById('fireStage');
            
            let newSrc, stageText;
            
            if (percentage > 75) {
                newSrc = fireStages.high;
                stageText = 'üî• Fire: High';
            } else if (percentage > 50) {
                newSrc = fireStages.mid;
                stageText = 'üî• Fire: Medium';
            } else if (percentage > 25) {
                newSrc = fireStages.low;
                stageText = 'üî• Fire: Low';
            } else {
                newSrc = fireStages.none;
                stageText = 'üí® Fire: Embers';
            }
            
            if (backgroundImg.src !== newSrc && !backgroundImg.src.endsWith(newSrc)) {
                backgroundImg.src = newSrc;
                fireStageText.textContent = stageText;
            }
        }

        function updateCurrentSessionInfo() {
            const infoElement = document.getElementById('currentSessionInfo');
            if (currentSessionStartTime && isRunning) {
                const startTime = new Date(currentSessionStartTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                infoElement.textContent = `‚è±Ô∏è Started at ${startTime}`;
            } else {
                infoElement.textContent = '';
            }
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function updateDisplay() {
            document.getElementById('timer').textContent = formatTime(timeLeft);
            const progressPercentage = (timeLeft / totalTime) * 100;
            document.getElementById('progressBar').style.width = progressPercentage + '%';
            updateCampfireGif();
            updateCurrentSessionInfo();
            updateFloatingTimer();
        }

        // ============================================
        // TIMER FUNCTIONS
        // ============================================
        function startTimer() {
            if (!isRunning) {
                isRunning = true;
                currentSessionStartTime = new Date();
                document.getElementById('startBtn').disabled = true;
                document.getElementById('pauseBtn').disabled = false;
                
                // Start ticking sound if enabled
                if (tickingEnabled) {
                    startTickingSound();
                }
                
                timerInterval = setInterval(() => {
                    timeLeft--;
                    updateDisplay();
                    
                    if (timeLeft <= 0) {
                        completeSession();
                    }
                }, 1000);
            }
        }

        function pauseTimer() {
            if (isRunning) {
                isRunning = false;
                clearInterval(timerInterval);
                document.getElementById('startBtn').disabled = false;
                document.getElementById('pauseBtn').disabled = true;
                
                // Stop ticking sound
                stopTickingSound();
                
                if (currentSessionStartTime) {
                    const sessionType = document.getElementById('sessionType').textContent;
                    saveSession(sessionType, currentSessionStartTime, new Date(), false);
                    currentSessionStartTime = null;
                }
            }
        }

        function resetTimer() {
            pauseTimer();
            
            if (isWorkSession) {
                timeLeft = workDuration * 60;
                totalTime = workDuration * 60;
            } else {
                const isLongBreak = completedPomodoros % 4 === 0;
                timeLeft = isLongBreak ? longBreakDuration * 60 : shortBreakDuration * 60;
                totalTime = timeLeft;
            }
            
            updateDisplay();
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
        }

        function completeSession() {
            pauseTimer();
            
            createNotificationSound();
            
            if (currentSessionStartTime) {
                const sessionType = document.getElementById('sessionType').textContent;
                saveSession(sessionType, currentSessionStartTime, new Date(), true);
                currentSessionStartTime = null;
            }
            
            if (isWorkSession) {
                completedPomodoros++;
                
                if (completedPomodoros % 4 === 0) {
                    timeLeft = longBreakDuration * 60;
                    totalTime = longBreakDuration * 60;
                    document.getElementById('sessionType').textContent = 'Long Break';
                } else {
                    timeLeft = shortBreakDuration * 60;
                    totalTime = shortBreakDuration * 60;
                    document.getElementById('sessionType').textContent = 'Short Break';
                }
                isWorkSession = false;
            } else {
                timeLeft = workDuration * 60;
                totalTime = workDuration * 60;
                isWorkSession = true;
                document.getElementById('sessionType').textContent = 'Work Session';
            }
            
            updateDisplay();
            alert('Session complete! ' + (isWorkSession ? 'Time to work!' : 'Time for a break!'));
        }

        function skipSession() {
            pauseTimer();
            
            if (isWorkSession) {
                if (completedPomodoros % 4 === 3) {
                    timeLeft = longBreakDuration * 60;
                    totalTime = longBreakDuration * 60;
                    document.getElementById('sessionType').textContent = 'Long Break';
                } else {
                    timeLeft = shortBreakDuration * 60;
                    totalTime = shortBreakDuration * 60;
                    document.getElementById('sessionType').textContent = 'Short Break';
                }
                completedPomodoros++;
                isWorkSession = false;
            } else {
                timeLeft = workDuration * 60;
                totalTime = workDuration * 60;
                isWorkSession = true;
                document.getElementById('sessionType').textContent = 'Work Session';
            }
            
            updateDisplay();
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        window.onload = function() {
            generateStars();
            
            const savedSessions = localStorage.getItem('pomodoroSessions');
            if (savedSessions) {
                sessions = JSON.parse(savedSessions);
            }

            const savedBackground = localStorage.getItem('customBackground');
            if (savedBackground) {
                isUsingCustomBackground = true;
                customBackgroundURL = savedBackground;
                document.getElementById('backgroundGif').src = savedBackground;
            }

            const savedOpacity = localStorage.getItem('backgroundOpacity');
            if (savedOpacity) {
                document.getElementById('opacitySlider').value = savedOpacity;
                changeBackgroundOpacity(savedOpacity);
            }
            
            // Load ticking sound preference
            const savedTicking = localStorage.getItem('tickingEnabled');
            if (savedTicking === 'true') {
                tickingEnabled = true;
                document.getElementById('tickingSoundCheckbox').checked = true;
            }
            
            updateStats();
            displayRecentSessions();
            createPieChart();
            updateDisplay();
        };

        window.addEventListener('beforeunload', () => {
            localStorage.setItem('pomodoroSessions', JSON.stringify(sessions));
            
            if (myConnectionRef) {
                myConnectionRef.remove();
            }
        });
    </script>
</body>
</html>
